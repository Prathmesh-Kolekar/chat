<!DOCTYPE html>
<html>
<head>
  <title>Chatbot Interface</title>
  <style>
    /* Chat container styles */
    #chatbot-container {
      width: 400px;
      height: 500px;
      background-color: #f7f7f7;
      border-radius: 8px;
      padding: 16px;
      overflow-y: scroll;
    }

    #chatbot-messages {
      height: 80%;
      overflow-y: auto;
    }

    #user-input-container {
      display: flex;
      margin-top: 16px;
    }

    #start-button,
    #stop-button {
      padding: 8px 16px;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .user-message {
      background-color: #eff6ff;
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 4px;
    }

    .chatbot-message {
      background-color: #f1f1f1;
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div id="chatbot-container">
    <div id="chatbot-messages"></div>
    <div id="user-input-container">
      <button id="start-button">Start</button>
      <button id="stop-button" disabled>Stop</button>
    </div>
  </div>
  <script>
    const startButton = document.getElementById('start-button');
    const stopButton = document.getElementById('stop-button');
    const chatbotMessages = document.getElementById('chatbot-messages');

    // Create a SpeechRecognition instance
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const speechRecognition = new SpeechRecognition();
    speechRecognition.lang = 'en-US'; // Set the desired language

    let isListening = false;
    let silenceTimeout = null;
    const silenceThreshold = 2000; // Adjust the silence threshold in milliseconds

    function displayUserMessage(message) {
      const userMessageElement = document.createElement('div');
      userMessageElement.classList.add('user-message');
      userMessageElement.textContent = message;
      chatbotMessages.appendChild(userMessageElement);
      chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }

    function displayChatbotMessage(message) {
      const chatbotMessageElement = document.createElement('div');
      chatbotMessageElement.classList.add('chatbot-message');
      chatbotMessageElement.textContent = message;
      chatbotMessages.appendChild(chatbotMessageElement);
      chatbotMessages.scrollTop = chatbotMessages.scrollHeight;

      // Speak out the chatbot's response
      const speechMessage = new SpeechSynthesisUtterance(message);
      speechSynthesis.speak(speechMessage);
    }

    function handleSpeechRecognition(event) {
      const lastResult = event.results[event.results.length - 1];
      const transcript = lastResult[0].transcript;
      displayUserMessage(transcript);

      // Make a request to the backend server with the user message
      fetch('/chatbot', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: transcript }),
      })
        .then(response => response.json())
        .then(data => {
          const { reply } = data;
          displayChatbotMessage(reply);
        })
        .catch(error => {
          console.error('Error:', error);
        });

      // Reset the silence timeout
      clearTimeout(silenceTimeout);
      silenceTimeout = setTimeout(() => {
        speechRecognition.stop();
        startButton.disabled = false;
        stopButton.disabled = true;
        isListening = false;
      }, silenceThreshold);
    }

    // Start speech recognition on button click
    startButton.addEventListener('click', () => {
      if (!isListening) {
        speechRecognition.start();
        startButton.disabled = true;
        stopButton.disabled = false;
        isListening = true;
      }
    });

    // Stop speech recognition on button click
    stopButton.addEventListener('click', () => {
      speechRecognition.stop();
      startButton.disabled = false;
      stopButton.disabled = true;
      isListening = false;
    });

    // Process speech recognition results
    speechRecognition.addEventListener('result', handleSpeechRecognition);
  </script>
</body>
</html>
